# MuseTalk S3 API Documentation

This document provides information about the MuseTalk S3 API, which extends the original MuseTalk API with S3 integration capabilities.

## Overview

The MuseTalk S3 API allows you to:

1. Use S3 paths for input video and audio files
2. Automatically download files from S3 for processing
3. Generate output filenames based on input file names
4. Upload output files to S3 after processing

## API Endpoint

The API runs on port 8080 by default:

```
http://localhost:8080/inference
```

## Request Format

The API accepts POST requests with the following parameters:

### Query Parameters

- `avatar_id`: ID of the avatar to use (must match a key in the `avatars` configuration)
- `audio_id`: ID of the audio clip to use (must match a key in the `audio_clips` configuration for the specified avatar)

### Request Body

The request body should be a JSON object with the following structure:

```json
{
  "version": "v15",
  "ffmpeg_path": "./ffmpeg/ffmpeg-master-latest-linux64-gpl/bin/",
  "gpu_id": 0,
  "vae_type": "sd-vae",
  "unet_config": "./models/musetalk/musetalk.json",
  "unet_model_path": "./models/musetalk/pytorch_model.bin",
  "whisper_dir": "./models/whisper",
  "bbox_shift": 0,
  "result_dir": "./results",
  "extra_margin": 10,
  "fps": 25,
  "audio_padding_length_left": 2,
  "audio_padding_length_right": 2,
  "batch_size": 30,
  "output_vid_name": null,
  "use_saved_coord": false,
  "saved_coord": false,
  "parsing_mode": "jaw",
  "left_cheek_width": 90,
  "right_cheek_width": 90,
  "skip_save_images": false,
  "s3_bucket": "sushant-bucket-mumbai",
  "s3_prefix": "aws_summit_2025_persona_sync/lip_sync/outputs",
  "avatars": {
    "avator_1": {
      "preparation": true,
      "video_path": "s3://sushant-bucket-mumbai/aws_summit_2025_persona_sync/pseudo_video_generator/outputs/0606446c_avatar_video.mp4",
      // (these are inputs from the prior steps to the musetalk model)
      "audio_clips": {
        "audio_0": "s3://sushant-bucket-mumbai/aws_summit_2025_persona_sync/seedvc/recreated_audio/remix_vc_00098415_audio.wav"
      // (these are inputs from the prior steps to the musetalk model)
      }
    }
  }
}
```

### S3-Specific Parameters

- `s3_bucket`: (optional) The S3 bucket to upload output files to. Default: "sushant-bucket-mumbai"
- `s3_prefix`: (optional) The S3 prefix (folder path) to upload output files to. Default: "aws_summit_2025_persona_sync/lip_sync/outputs"
- `output_vid_name`: If set to `null`, the output filename will be generated by combining the video and audio filenames

### S3 Path Format

S3 paths should be specified in the following format:

```
s3://bucket-name/path/to/file.ext
```

For example:

```
s3://sushant-bucket-mumbai/aws_summit_2025_persona_sync/lip_sync/inputs/video.mp4
```

## Response Format

The API returns a JSON response with the following structure:

```json
{
  "avatar_id": "avator_1",
  "audio_id": "audio_0",
  "output_path": "/path/to/local/output/file.mp4",
  "s3_output_path": "s3://bucket-name/path/to/output/file.mp4",
  "message": "Inference completed successfully"
}
```

### Response Fields

- `avatar_id`: The ID of the avatar used for inference
- `audio_id`: The ID of the audio clip used for inference
- `output_path`: The local path to the output file
- `s3_output_path`: The S3 path where the output file was uploaded
- `message`: A message indicating the status of the inference

## AWS Credentials

The API uses the default AWS credential provider chain to authenticate with AWS. You can configure your AWS credentials using one of the following methods:

1. Environment variables: `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY`
2. AWS credentials file: `~/.aws/credentials`
3. IAM role for Amazon EC2 instances

## Example Usage

See `client_example_s3.py` for an example of how to use the API.

## Error Handling

The API returns appropriate HTTP status codes and error messages for different types of errors:

- `400 Bad Request`: Invalid request parameters
- `500 Internal Server Error`: Server-side errors during processing

## Running the API

To run the API, use the following command:

```bash
python api_s3.py
```

This will start the API server on port 8080.
